generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Network {
  MAINNET
  TESTNET
}

enum OrderStatus {
  PENDING
  CONFIRMED
  EXPIRED
  FAILED
}

model PaymentRoute {
  id        String   @id @default(uuid())
  coin      Coin     @relation("CoinToPaymentRoute", fields: [coinId], references: [id])
  coinId    String
  network   Network
  protocol  String
  address   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relasi ke Order
  orders Order[] @relation("PaymentRouteToOrder")
}

model Coin {
  id        String   @id @default(uuid())
  network   Network  @default(TESTNET)
  name      String
  symbol    String   @unique
  iconUrl   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relasi
  basePairs     Pair[]         @relation("BaseCoin")
  quotePairs    Pair[]         @relation("QuoteCoin")
  paymentRoutes PaymentRoute[] @relation("CoinToPaymentRoute")
}

model Pair {
  id          String   @id @default(uuid())
  network     Network  @default(TESTNET)
  baseCoin    Coin     @relation("BaseCoin", fields: [baseCoinId], references: [id])
  baseCoinId  String
  quoteCoin   Coin     @relation("QuoteCoin", fields: [quoteCoinId], references: [id])
  quoteCoinId String
  priceBase   Float
  priceQuote  Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relasi
  orders Order[]
}

model Order {
  id                 String      @id @default(uuid())
  network            Network     @default(TESTNET)
  orderHash          String      @unique
  pair               Pair        @relation(fields: [pairId], references: [id])
  pairId             String
  amount             Float
  addressDestination String
  /// Unique address derived from HD wallet for payment
  paymentAddress     String?
  /// HD wallet index used to derive paymentAddress
  hdIndex            Int?
  status             OrderStatus @default(PENDING)
  expiresAt          DateTime
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  // Relasi
  history        OrderHistory?
  paymentRoute   PaymentRoute  @relation("PaymentRouteToOrder", fields: [paymentRouteId], references: [id])
  paymentRouteId String
}

model OrderHistory {
  id          String   @id @default(uuid())
  network     Network  @default(TESTNET)
  order       Order    @relation(fields: [orderId], references: [id])
  orderId     String   @unique
  txHash      String   @unique
  confirmedAt DateTime
}
